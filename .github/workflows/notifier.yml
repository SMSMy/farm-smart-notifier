name: Farm Notifier Scheduler

on:
  schedule:
    # ูุนูู ูู ููู ูู ุงูุณุงุนุฉ 6:00 ู 18:00 ุจุชูููุช ููุฉ ุงูููุฑูุฉ (UTC+3)
    # 03:00 UTC = 06:00 ููุฉ
    # 15:00 UTC = 18:00 ููุฉ
    - cron: '0 3,15 * * *'
  workflow_dispatch:  # ุฅููุงููุฉ ุงูุชุดุบูู ุงููุฏูู

jobs:
  run-notifier:
    runs-on: ubuntu-latest
    name: ุชุดุบูู ูุธุงู ุงูุชูุจูู
    
    steps:
      - name: ๐ฅ ุฌูุจ ุงูููุฏ
        uses: actions/checkout@v4
        
      - name: ๐ ุฅุนุฏุงุฏ Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: ๐ฆ ุชุซุจูุช ุงููุชุทูุจุงุช
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: ๐ง ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
        run: |
          # ุชุญุฏูุซ ุงูุชูููุงุช ูู ููู config.json
          sed -i "s/YOUR_BOT_TOKEN_HERE/$TELEGRAM_BOT_TOKEN/g" config.json
          sed -i "s/YOUR_CHAT_ID_HERE/$TELEGRAM_CHAT_ID/g" config.json  
          sed -i "s/YOUR_OPENWEATHERMAP_API_KEY_HERE/$OPENWEATHER_API_KEY/g" config.json
          
          # ุงูุชุญูู ูู ุฃู ุฌููุน ุงูุชูููุงุช ุชู ุชุญุฏูุซูุง
          echo "๐ ุงูุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช..."
          if grep -q "YOUR_BOT_TOKEN_HERE" config.json; then
            echo "โ ูุดู ุชุญุฏูุซ bot_token"
            exit 1
          fi
          if grep -q "YOUR_CHAT_ID_HERE" config.json; then
            echo "โ ูุดู ุชุญุฏูุซ chat_id"  
            exit 1
          fi
          if grep -q "YOUR_OPENWEATHERMAP_API_KEY_HERE" config.json; then
            echo "โ ูุดู ุชุญุฏูุซ API key"
            exit 1
          fi
          echo "โ ุชู ุชุญุฏูุซ ุฌููุน ุงูุชูููุงุช ุจูุฌุงุญ"
          
      - name: ๐ ุชุดุบูู ุงููุธุงู
        run: |
          echo "๐ฑ ุจุฏุก ุชุดุบูู ูุธุงู ุงูุชูุจูู ุงูุฐูู ูููุฒุฑุนุฉ..."
          python app.py  # <<<=== ุชู ุชุตุญูุญ ุงุณู ุงูููู ููุง
          
      - name: ๐ Upload logs and last run status
        if: always() # ูุนูู ุฏุงุฆููุง ุณูุงุก ูุฌุญุช ุงููููุฉ ุฃู ูุดูุช
        uses: actions/upload-artifact@v4
        with:
          name: farm-notifier-run-data
          path: |
            .last_run   # <<<=== ุชู ุงูุชุนุฏูู ููุดูู ููุท ุงูููู ุงูุฐู ูุชู ุฅูุดุงุคู
          retention-days: 7
