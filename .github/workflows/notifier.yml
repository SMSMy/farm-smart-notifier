# ุงุณู ุณูุฑ ุงูุนูู ุงูุฐู ูุธูุฑ ูู ุชุจููุจ Actions ุนูู GitHub
name: Farm Notifier Scheduler

# ุงูุฃุญุฏุงุซ ุงูุชู ุชุคุฏู ุฅูู ุชุดุบูู ุณูุฑ ุงูุนูู
on:
  # ุงูุชุดุบูู ุงููุฌุฏูู
  schedule:
    # ูุนูู ูู ููู ูู ุงูุณุงุนุฉ 3:00 ู 15:00 ุจุงูุชูููุช ุงูุนุงููู ุงูููุณู (UTC)
    # ููู ูุง ููุงูู 6:00 ุตุจุงุญูุง ู 6:00 ูุณุงุกู ุจุชูููุช ููุฉ ุงูููุฑูุฉ (UTC+3)
    - cron: "0 3,15 * * *"

  # ูุชูุญ ุฅููุงููุฉ ุงูุชุดุบูู ุงููุฏูู ูู ูุงุฌูุฉ GitHub Actions
  workflow_dispatch:

# ุชุนุฑูู ุงูููุงู ุงูุชู ุณูุชู ุชูููุฐูุง
jobs:
  run-notifier:
    # ุงุณู ุงููููุฉ ุงูุฐู ูุธูุฑ ูู ูุงุฌูุฉ GitHub
    name: ุชุดุบูู ูุธุงู ุงูุชูุจูู

    # ููุน ุงููุธุงู ุงูุฐู ุณุชุนูู ุนููู ุงููููุฉ (ุฃุญุฏุซ ุฅุตุฏุงุฑ ูู ุฃูุจููุชู)
    runs-on: ubuntu-latest

    # ุฎุทูุงุช ุงูุชูููุฐ ุจุงูุชุณูุณู
    steps:
      # ุงูุฎุทูุฉ 1: ุฌูุจ ุงูููุฏ ูู ุงููุณุชูุฏุน
      - name: ๐ฅ ุฌูุจ ุงูููุฏ
        uses: actions/checkout@v4

      # ุงูุฎุทูุฉ 2: ุฅุนุฏุงุฏ ุจูุฆุฉ Python ุจุงูุฅุตุฏุงุฑ ุงููุญุฏุฏ
      - name: ๐ ุฅุนุฏุงุฏ Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # ุงูุฎุทูุฉ 3: ุชุซุจูุช ุงูููุชุจุงุช ุงููุทููุจุฉ ูู ููู requirements.txt
      - name: ๐ฆ ุชุซุจูุช ุงููุชุทูุจุงุช
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ุงูุฎุทูุฉ 4: ุชุญุฏูุซ ููู ุงูุฅุนุฏุงุฏุงุช ุจุงุณุชุฎุฏุงู ุงูุฃุณุฑุงุฑ (Secrets)
      - name: ๐ง ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
        run: |
          # ุงุณุชุจุฏุงู ุงููุตูุต ุงููุคูุชุฉ ูู config.json ุจุงูููู ุงููุนููุฉ ูู GitHub Secrets
          sed -i "s|YOUR_BOT_TOKEN_HERE|$TELEGRAM_BOT_TOKEN|g" config.json
          sed -i "s|YOUR_CHAT_ID_HERE|$TELEGRAM_CHAT_ID|g" config.json
          sed -i "s|YOUR_OPENWEATHERMAP_API_KEY_HERE|$OPENWEATHER_API_KEY|g" config.json

          # ุงูุชุญูู ููุชุฃูุฏ ูู ุฃู ุฌููุน ุงูููู ูุฏ ุชู ุงุณุชุจุฏุงููุง ุจูุฌุงุญ
          echo "๐ ุงูุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช..."
          if grep -q "YOUR_BOT_TOKEN_HERE" config.json; then
            echo "โ ูุดู ุชุญุฏูุซ bot_token"
            exit 1
          fi
          if grep -q "YOUR_CHAT_ID_HERE" config.json; then
            echo "โ ูุดู ุชุญุฏูุซ chat_id"
            exit 1
          fi
          if grep -q "YOUR_OPENWEATHERMAP_API_KEY_HERE" config.json; then
            echo "โ ูุดู ุชุญุฏูุซ API key"
            exit 1
          fi
          echo "โ ุชู ุชุญุฏูุซ ุฌููุน ุงูุชูููุงุช ุจูุฌุงุญ"

      # ุงูุฎุทูุฉ 5: ุชุดุบูู ุงูุณูุฑุจุช ุงูุฑุฆูุณู ููุชุทุจูู
      - name: ๐ ุชุดุบูู ุงููุธุงู
        run: |
          echo "๐ฑ ุจุฏุก ุชุดุบูู ูุธุงู ุงูุชูุจูู ุงูุฐูู ูููุฒุฑุนุฉ..."
          # ุชู ุชุตุญูุญ ุงุณู ุงูููู ููุง ุฅูู app.py
          python app.py

      # ุงูุฎุทูุฉ 6: ุฑูุน ููู ุญุงูุฉ ุงูุชุดุบูู ูู "artifact" ููุงุญุชูุงุธ ุจู
      - name: ๐พ ุฑูุน ููู ุขุฎุฑ ุชุดุบูู
        # ุชุนูู ูุฐู ุงูุฎุทูุฉ ุฏุงุฆููุงุ ุณูุงุก ูุฌุญุช ุงููููุฉ ุฃู ูุดูุชุ ูุงูุชูุงุท ุงูุญุงูุฉ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          # ุงุณู ุงูุญุฒูุฉ ุงูุชู ุณูุชู ุฑูุนูุง
          name: farm-notifier-run-status
          # ุงููุณุงุฑ ูููููุงุช ุงูุชู ุณูุชู ุฑูุนูุง
          path: .last_run
          # ูุฏุฉ ุงูุงุญุชูุงุธ ุจุงูููู (ุฃูุงู)
          retention-days: 7
          # ูู ุญุงู ุนุฏู ุงูุนุซูุฑ ุนูู ุงููููุ ุณูุชู ุนุฑุถ ุชุญุฐูุฑ ุจุฏูุงู ูู ุงูุชุณุจุจ ูู ูุดู ุงููููุฉ
          if-no-files-found: warn

      # ุงูุฎุทูุฉ 7: ุชุณุฌูู ุชูุงุตูู ุฅุถุงููุฉ ูู ุญุงูุฉ ูุดู ุงููููุฉ ููุท
      - name: ๐ ุชุณุฌูู ุงูุชูุงุตูู ุนูุฏ ุงููุดู
        # ุชุนูู ูุฐู ุงูุฎุทูุฉ ููุท ุฅุฐุง ูุดูุช ุฃู ูู ุงูุฎุทูุงุช ุงูุณุงุจูุฉ
        if: failure()
        run: |
          echo "โ ูุดู ูู ุงูุชุดุบูู - ุชูุงุตูู ุงูุฎุทุฃ:"
          echo "--- ุจุฏุงูุฉ ููู ุงูุฅุนุฏุงุฏุงุช config.json ---"
          # ุนุฑุถ ุฃูู 10 ุฃุณุทุฑ ูู ููู ุงูุฅุนุฏุงุฏุงุช ูููุณุงุนุฏุฉ ูู ุชุดุฎูุต ุฃุฎุทุงุก ุงูุชูููุงุช
          cat config.json | head -10
          echo "--- ููุงูุฉ ููู ุงูุฅุนุฏุงุฏุงุช ---"
